<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie AI Chatbot - Neon UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- ƒê·ªãnh nghƒ©a m√†u Neon --- */
      :root {
        --color-primary: #00ffc8; /* Neon Teal */
        --color-secondary: #ff007f; /* Neon Pink/Magenta */
        --color-dark-bg: #030a10; /* N·ªÅn c·ª±c t·ªëi */
        --color-surface: #0a1320; /* B·ªÅ m·∫∑t t·ªëi s√¢u */
        --color-border: #1a2a40;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--color-dark-bg);
        background-image: radial-gradient(
          circle at center,
          #1b002c 0%,
          var(--color-dark-bg) 100%
        );
      }

      /* --- Hi·ªáu ·ª©ng vi·ªÅn Neon --- */
      .neon-border {
        border: 2px solid var(--color-border);
        border-radius: 20px;
        box-shadow: 0 0 10px rgba(0, 255, 200, 0.4),
          0 0 20px rgba(255, 0, 127, 0.3), inset 0 0 15px rgba(0, 255, 200, 0.1);
      }

      /* --- Giao di·ªán chat --- */
      .chat-container {
        height: 65vh;
        overflow-y: auto;
        background-color: var(--color-surface);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8);
        scroll-behavior: smooth;
      }

      /* --- Message Styling --- */
      .message {
        max-width: 85%; /* TƒÉng ƒë·ªô r·ªông ƒë·ªÉ hi·ªÉn th·ªã n·ªôi dung d√†i t·ªët h∆°n */
        padding: 12px 18px;
        border-radius: 15px;
        margin-bottom: 15px;
        font-size: 0.95rem;
        line-height: 1.5;
        animation: fadeIn 0.3s ease-out forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .user-message {
        background-color: #0d47a1;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
        box-shadow: 0 2px 8px rgba(13, 71, 161, 0.5);
      }
      .ai-message {
        background-color: #212c3d;
        align-self: flex-start;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 8px rgba(33, 44, 61, 0.5);
      }

      /* --- STYLE CHO MARKDOWN CONTENT (Quan tr·ªçng) --- */
      /* V√¨ Tailwind reset h·∫øt style, c·∫ßn ƒë·ªãnh nghƒ©a l·∫°i cho ƒë·∫πp */
      .message h1, .message h2, .message h3, .message h4 {
        color: var(--color-primary);
        font-weight: 700;
        margin-top: 12px;
        margin-bottom: 6px;
        text-shadow: 0 0 5px rgba(0, 255, 200, 0.3);
      }
      .message h1 { font-size: 1.5em; }
      .message h2 { font-size: 1.3em; }
      .message h3 { font-size: 1.15em; }
      .message h4 { font-size: 1.05em; text-decoration: underline; text-decoration-color: var(--color-secondary); }
      
      .message ul { list-style-type: disc; padding-left: 20px; margin-bottom: 10px; }
      .message ol { list-style-type: decimal; padding-left: 20px; margin-bottom: 10px; }
      .message li { margin-bottom: 4px; }
      
      .message strong { 
        color: var(--color-secondary); 
        font-weight: bold;
      }
      .message p { margin-bottom: 8px; }
      .message p:last-child { margin-bottom: 0; }

      /* --- C√°c n√∫t ch·∫ø ƒë·ªô --- */
      .mode-button {
        transition: all 0.2s ease-in-out;
        border: 1px solid transparent;
      }
      .mode-button:hover { transform: scale(1.05); }
      .mode-button.active {
        border-color: var(--shadow-color);
        box-shadow: 0 0 15px var(--shadow-color);
        text-shadow: 0 0 5px var(--shadow-color);
        transform: translateY(-2px);
      }

      #mode-semantic { background-color: #00a880; }
      #mode-recommend { background-color: #7b00a8; }
      #mode-semantic.active { --shadow-color: var(--color-primary); }
      #mode-recommend.active { --shadow-color: var(--color-secondary); }

      /* --- Input & Button --- */
      .chat-input {
        background-color: #1a2a40;
        border: 1px solid #30363d;
        box-shadow: 0 0 5px rgba(0, 255, 200, 0.2);
      }
      .chat-input:focus {
        box-shadow: 0 0 0 1px var(--color-primary) inset, 0 0 10px var(--color-primary);
        border-color: var(--color-primary);
      }

      #send-button {
        background-color: var(--color-primary);
        color: var(--color-dark-bg);
        font-weight: bold;
        box-shadow: 0 0 15px var(--color-primary);
      }
      #send-button:hover:not(:disabled) {
        background-color: #00d9a8;
        box-shadow: 0 0 25px var(--color-primary);
        transform: scale(1.05);
      }

      /* --- Typing Effect --- */
      .typing-effect {
        border-right: 2px solid var(--color-primary);
        display: inline-block;
        animation: blink-caret 0.75s step-end infinite;
      }
      .no-typing { border-right: none !important; }
      @keyframes blink-caret {
        from, to { border-color: transparent; }
        50% { border-color: var(--color-primary); }
      }
    </style>
  </head>
  <body class="text-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
      <header class="text-center mb-8">
        <h1
          class="text-5xl font-extrabold text-white mb-2"
          style="text-shadow: 0 0 15px var(--color-primary)"
        >
          Movie AI Chatbot
        </h1>
        <p class="text-lg text-gray-400">Ch·ªçn ch·∫ø ƒë·ªô t√¨m ki·∫øm ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
      </header>

      <div class="flex justify-center space-x-6 mb-8">
        <button
          id="mode-semantic"
          data-mode="SEMANTIC_SEARCH"
          class="mode-button p-3 text-white font-bold rounded-full transition duration-150 active"
        >
          üîç T√¨m ki·∫øm Ng·ªØ nghƒ©a
        </button>
        <button
          id="mode-recommend"
          data-mode="TFIDF_RECOMMEND"
          class="mode-button p-3 text-white font-bold rounded-full transition duration-150"
        >
          ‚≠ê G·ª£i √Ω Phim T∆∞∆°ng t·ª±
        </button>
      </div>

      <div
        id="chat-container"
        class="chat-container rounded-3xl p-6 flex flex-col space-y-3 neon-border"
      >
        <div class="message ai-message text-sm">
          Ch√†o b·∫°n! B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô <strong>T√¨m ki·∫øm Ng·ªØ nghƒ©a</strong>. H√£y nh·∫≠p m√¥ t·∫£ ho·∫∑c c·ªët truy·ªán.
        </div>
      </div>

      <div class="mt-6 flex space-x-3">
        <input
          type="text"
          id="chat-input"
          placeholder="Nh·∫≠p c√¢u h·ªèi ho·∫∑c t√™n phim..."
          class="chat-input flex-grow p-4 rounded-xl text-gray-100 focus:outline-none"
          onkeypress="if(event.key === 'Enter') sendMessage()"
        />
        <button
          id="send-button"
          onclick="sendMessage()"
          class="p-4 rounded-xl disabled:bg-gray-500 disabled:shadow-none"
        >
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
          </svg>
        </button>
      </div>

      <div
        id="status-message"
        class="text-center text-sm mt-3 text-gray-500 hidden"
      >
        ƒêang x·ª≠ l√Ω...
      </div>
      <div
        id="error-message"
        class="text-red-400 bg-red-900 bg-opacity-30 p-2 rounded-lg mt-3 hidden"
      ></div>
    </div>

    <script>
      const API_BASE_URL = "http://127.0.0.1:5001";
      const chatContainer = document.getElementById("chat-container");
      const chatInput = document.getElementById("chat-input");
      const sendButton = document.getElementById("send-button");
      const statusMessage = document.getElementById("status-message");
      const errorMessage = document.getElementById("error-message");

      let searchMode = "SEMANTIC_SEARCH";
      let isTyping = false;

      // --- H√ÄM X·ª¨ L√ù TEXT: D√πng Marked.js ---
      function formatTextForDisplay(text) {
        // Chuy·ªÉn ƒë·ªïi Markdown sang HTML (h·ªó tr·ª£ xu·ªëng d√≤ng v·ªõi <br>)
        marked.setOptions({
          breaks: true,
          gfm: true
        });
        return marked.parse(text);
      }

      // --- H√ÄM TYPING EFFECT (ƒê√£ t·ªëi ∆∞u t·ªëc ƒë·ªô) ---
      function typeWriter(element, formattedHtml, delay = 5) {
        // 1. T·∫°o m·ªôt th·∫ª t·∫°m ƒë·ªÉ l·∫•y Plain Text (v√¨ g√µ HTML tag r·∫•t x·∫•u)
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = formattedHtml;
        const pureText = tempDiv.textContent || tempDiv.innerText;

        let i = 0;
        element.innerHTML = ""; // X√≥a n·ªôi dung c≈©

        // T·ªëc ƒë·ªô: g√µ 3 k√Ω t·ª± m·ªôt l√∫c (chunk)
        const step = 3; 

        function type() {
          if (i < pureText.length) {
            // L·∫•y 1 c·ª•m k√Ω t·ª±
            const chunk = pureText.substring(i, i + step);
            element.innerHTML += chunk;
            i += step;

            // T·ª± ƒë·ªông cu·ªôn xu·ªëng
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // X·ª≠ l√Ω con tr·ªè nh·∫•p nh√°y
            let lastChild = element.querySelector('.typing-effect');
            if (!lastChild) {
                const cursor = document.createElement("span");
                cursor.className = "typing-effect";
                element.appendChild(cursor);
            } else {
                element.appendChild(lastChild); // ƒê·∫©y con tr·ªè xu·ªëng cu·ªëi
            }

            setTimeout(type, delay);
          } else {
            // KHI HO√ÄN TH√ÄNH:
            // Thay th·∫ø to√†n b·ªô text b·∫±ng HTML ƒë√£ render (ƒë·ªÉ hi·ªán m√†u, bold, header...)
            element.innerHTML = formattedHtml;
            
            // X√≥a con tr·ªè nh·∫•p nh√°y
            const cursor = element.querySelector(".typing-effect");
            if (cursor) cursor.remove();
            
            isTyping = false;
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        }
        type();
      }

      function addMessage(text, isUser, toolUsed = null) {
        const msgDiv = document.createElement("div");
        msgDiv.className = `message text-gray-100 ${
          isUser ? "user-message" : "ai-message"
        }`;
        msgDiv.style.alignSelf = isUser ? "flex-end" : "flex-start";

        const formattedHtml = formatTextForDisplay(text);

        let toolInfo = "";
        if (!isUser && toolUsed && toolUsed !== "none") {
          const toolMap = {
            semantic:
              '<span style="color: var(--color-primary);">üîç Semantic Search (Pinecone)</span>',
            tfidf:
              '<span style="color: var(--color-secondary);">‚≠ê G·ª£i √Ω Phim T∆∞∆°ng t·ª± (TF-IDF)</span>',
          };
          const toolName = toolMap[toolUsed] || "ƒêang s·ª≠ d·ª•ng Tool";
          // Th√™m border-bottom nh·∫π ƒë·ªÉ t√°ch bi·ªát t√™n tool v√† n·ªôi dung
          toolInfo = `<div class="mb-2 pb-2 border-b border-gray-700 text-xs font-semibold">${toolName}</div>`;
        }

        if (isUser) {
          msgDiv.innerHTML = formattedHtml;
          chatContainer.appendChild(msgDiv);
        } else {
          // Tin nh·∫Øn AI
          msgDiv.innerHTML = toolInfo; // Hi·ªán tool info tr∆∞·ªõc
          
          // T·∫°o div ch·ª©a n·ªôi dung ch√≠nh ƒë·ªÉ ch·∫°y hi·ªáu ·ª©ng g√µ
          const contentDiv = document.createElement("div");
          msgDiv.appendChild(contentDiv);
          chatContainer.appendChild(msgDiv);

          isTyping = true;
          // Ch·ªâ ch·∫°y hi·ªáu ·ª©ng g√µ cho ph·∫ßn n·ªôi dung tr·∫£ l·ªùi, gi·ªØ nguy√™n tool info
          typeWriter(contentDiv, formattedHtml);
        }

        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô
      document.querySelectorAll(".mode-button").forEach((button) => {
        button.addEventListener("click", () => {
          const newMode = button.getAttribute("data-mode");
          searchMode = newMode;

          document
            .querySelectorAll(".mode-button")
            .forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");

          let welcomeText = "";
          if (newMode === "SEMANTIC_SEARCH") {
            welcomeText = "B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô **T√¨m ki·∫øm Ng·ªØ nghƒ©a**. H√£y nh·∫≠p m√¥ t·∫£ ho·∫∑c c·ªët truy·ªán.";
          } else {
            welcomeText = "B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô **G·ª£i √Ω Phim T∆∞∆°ng t·ª±**. H√£y nh·∫≠p t√™n phim g·ªëc.";
          }
          addMessage(welcomeText, false);
        });
      });

      function setStatus(isLoading, errorText = "") {
        sendButton.disabled = isLoading;
        sendButton.innerHTML = isLoading
          ? '<div class="w-6 h-6 border-4 border-t-4 border-t-white border-gray-400 rounded-full animate-spin"></div>'
          : '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>';

        statusMessage.classList.toggle("hidden", !isLoading);
        errorMessage.classList.add("hidden");
        if (errorText) {
          errorMessage.textContent = errorText;
          errorMessage.classList.remove("hidden");
        }
      }

      async function sendMessage() {
        if (isTyping) return; // Ch·∫∑n spam enter khi ƒëang g√µ
        let query = chatInput.value.trim();
        if (!query) return;

        let finalQuery = `[MODE: ${searchMode}] ${query}`;

        addMessage(query, true);
        chatInput.value = "";
        setStatus(true);

        const url = `${API_BASE_URL}/chat`;

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: finalQuery }),
          });
          const data = await response.json();

          if (!response.ok) throw new Error(data.error || `L·ªói HTTP ${response.status}`);

          addMessage(data.response, false, data.tool_used);
        } catch (error) {
          console.error("Chatbot Error:", error);
          const errorMsg = `L·ªói k·∫øt n·ªëi: ${error.message}.`;
          addMessage(errorMsg, false);
          setStatus(false, errorMsg);
        } finally {
          setStatus(false);
        }
      }
    </script>
  </body>
</html>